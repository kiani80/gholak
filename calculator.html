<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ماشین حساب صندوق سرمایه گذاری سهمتو</title>
    <!-- اسکریپت‌های مورد نیاز -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* خواندن متغیرهای رنگ از کلاینت تلگرام با مقادیر پیش‌فرض */
            --tg-theme-bg-color: var(--tg-bg-color, #f8f9fa);
            --tg-theme-text-color: var(--tg-text-color, #222222);
            --tg-theme-button-color: var(--tg-button-color, #3498db);
            --tg-theme-button-text-color: var(--tg-button-text-color, #ffffff);
            --tg-theme-secondary-bg-color: var(--tg-secondary-bg-color, #ffffff);
            --tg-theme-hint-color: var(--tg-hint-color, #707579);
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            margin: 0;
            padding: 15px;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            background-color: var(--tg-theme-secondary-bg-color);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            font-size: clamp(18px, 4vw, 24px); /* فونت واکنش‌گرا */
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-field {
            display: flex;
            flex-direction: column;
            min-width: 200px;
            flex: 1;
        }

        label {
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--tg-theme-hint-color);
        }

        input {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--tg-theme-hint-color);
            font-size: 16px;
            text-align: left;
            direction: ltr;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
        }

        button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 16px;
            border-radius: 8px;
            width: 100%;
            font-family: 'Vazirmatn', sans-serif;
            transition: opacity 0.2s;
        }
        button:hover {
            opacity: 0.85;
        }

        .chart-container {
            position: relative;
            height: 300px; /* ارتفاع بهینه برای موبایل */
            margin-top: 20px;
        }

        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            text-align: center;
        }

        th, td {
            padding: 10px;
            border: 1px solid var(--tg-theme-hint-color);
        }

        th {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }

        #result {
            text-align: center;
            padding: 15px;
            background-color: var(--tg-theme-bg-color);
            border-radius: 8px;
            margin-top: 20px;
            display: none; /* در ابتدا مخفی */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ماشین حساب سرمایه گذاری دوره ای</h1>
        
        <div class="input-group">
            <div class="input-field">
                <label for="horizon">افق سرمایه‌گذاری (سال):</label>
                <input type="number" id="horizon" min="1" max="30" value="5">
            </div>
            
            <div class="input-field">
                <label for="investment">مبلغ ماهانه (تومان):</label>
                <input type="text" id="investment" value="2,000,000" oninput="formatNumber(this)">
            </div>
        </div>
        
        <div style="text-align: center;">
            <button id="calculateBtn">محاسبه کن</button>
        </div>
        
        <div class="chart-container">
            <canvas id="investmentChart"></canvas>
        </div>
        
        <div id="result"></div>
        
        <table>
            <thead>
                <tr>
                    <th>سال</th>
                    <th>پرداختی (میلیون تومان)</th>
                    <th>ارزش کل (میلیون تومان)</th>
                    <th>سود (میلیون تومان)</th>
                </tr>
            </thead>
            <tbody id="resultTableBody">
            </tbody>
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Telegram Web App Initialization ---
            try {
                const TWA = window.Telegram.WebApp;
                TWA.ready();
                TWA.expand();
            } catch (e) {
                console.error("Telegram Web App script not found or failed to load.", e);
            }

            const horizonInput = document.getElementById('horizon');
            const investmentInput = document.getElementById('investment');
            const calculateBtn = document.getElementById('calculateBtn');
            const resultDiv = document.getElementById('result');
            const resultTableBody = document.getElementById('resultTableBody');
            const ctx = document.getElementById('investmentChart').getContext('2d');
            let chartInstance = null;

            function formatNumber(input) {
                let num = input.value.replace(/\D/g, '');
                input.value = num ? parseInt(num, 10).toLocaleString('en-US') : '';
            }

            function parseFormattedNumber(formattedNumber) {
                return parseInt(String(formattedNumber).replace(/\D/g, '')) || 0;
            }

            function calculateInvestment() {
                const years = parseInt(horizonInput.value);
                const monthlyInvestment = parseFormattedNumber(investmentInput.value);
                const rate = 0.55 / 12; // 55% annual rate, compounded monthly

                let totalInvestment = 0;
                let totalValue = 0;
                resultTableBody.innerHTML = '';

                let yearsLabels = ['شروع'];
                let totalValueData = [0];

                for (let year = 1; year <= years; year++) {
                    for (let month = 1; month <= 12; month++) {
                        totalInvestment += monthlyInvestment;
                        totalValue = (totalValue + monthlyInvestment) * (1 + rate);
                    }

                    yearsLabels.push(`سال ${year}`);
                    totalValueData.push((totalValue / 1e6)); 

                    let row = `<tr>
                        <td>${year}</td>
                        <td>${(totalInvestment / 1e6).toLocaleString()}</td>
                        <td>${(totalValue / 1e6).toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                        <td>${((totalValue - totalInvestment) / 1e6).toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                    </tr>`;
                    resultTableBody.innerHTML += row;
                }

                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `ارزش نهایی سرمایه شما پس از ${years} سال حدود <strong>${(totalValue / 1e6).toLocaleString(undefined, {maximumFractionDigits: 0})} میلیون تومان</strong> خواهد بود.`;

                // --- Chart Drawing ---
                if (chartInstance) {
                    chartInstance.destroy();
                }

                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: yearsLabels,
                        datasets: [{
                            label: 'ارزش سرمایه (میلیون تومان)',
                            data: totalValueData,
                            borderColor: 'var(--tg-theme-button-color, #27ae60)',
                            backgroundColor: 'rgba(39, 174, 96, 0.2)',
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: { display: false },
                                ticks: { font: { family: 'Vazirmatn' }, color: 'var(--tg-theme-text-color)' }
                            },
                            y: {
                                title: { display: false },
                                ticks: { font: { family: 'Vazirmatn' }, color: 'var(--tg-theme-text-color)', beginAtZero: true }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    font: { family: 'Vazirmatn' },
                                    color: 'var(--tg-theme-text-color)'
                                }
                            }
                        }
                    }
                });
            }
            
            // Link formatNumber to the correct input element
            investmentInput.addEventListener('input', () => formatNumber(investmentInput));
            
            // Event listener for the calculate button
            calculateBtn.addEventListener('click', calculateInvestment);
            
            // Initial calculation on page load
            calculateInvestment();
        });
    </script>
</body>
</html>
