<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تست نهایی تریگر</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 20px; text-align: center; color: var(--tg-theme-text-color); background-color: var(--tg-theme-bg-color); }
        .container { max-width: 400px; margin: 0 auto; }
        input, button { width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border-radius: 8px; }
        button { background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); border: none; cursor: pointer; }
        #userInfo {
            margin-top: 25px;
            padding: 12px;
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 8px;
            font-family: monospace;
            text-align: left;
            direction: ltr;
            word-wrap: break-word;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>تست نهایی</h2>
        <p>برای تست، دکمه زیر را بزنید.</p>
        <button id="submitBtn">ارسال داده به n8n و بستن</button>

        <div id="userInfo">
            در حال بارگذاری اطلاعات کاربر...
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const tg = window.Telegram.WebApp;
                tg.ready();

                // بخش جدید: نمایش اطلاعات کاربر
                const userInfoDiv = document.getElementById('userInfo');
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    const user = tg.initDataUnsafe.user;
                    let userInfoText = `✅ اطلاعات با موفقیت خوانده شد:<br><br>`;
                    userInfoText += `<strong>ID:</strong> ${user.id}<br>`;
                    userInfoText += `<strong>First Name:</strong> ${user.first_name}<br>`;
                    if (user.username) {
                        userInfoText += `<strong>Username:</strong> @${user.username}`;
                    }
                    userInfoDiv.innerHTML = userInfoText;
                } else {
                    userInfoDiv.innerHTML = "❌ خطا: اطلاعات کاربر تلگرام یافت نشد. <br> آیا صفحه را خارج از محیط وب‌اپ تلگرام باز کرده‌اید؟";
                }

                // بخش ارسال داده
                document.getElementById('submitBtn').addEventListener('click', function() {
                    tg.sendData(JSON.stringify({ status: 'success', user: tg.initDataUnsafe.user }));
                    tg.close();
                });

            } catch (error) {
                document.getElementById('userInfo').innerText = "❌ خطای حیاتی در اسکریپت: " + error.message;
            }
        });
    </script>
</body>
</html>
