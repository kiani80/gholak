register.html<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>فرم ثبت نام</title>
    <script src="https://telegram.org/js/telegram-web-app.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Vazirmatn', sans-serif; max-width: 500px; margin: 0 auto; padding: 20px; background-color: var(--tg-theme-bg-color, #f4f7f6); color: var(--tg-theme-text-color, #333); }
        .container { background-color: var(--tg-theme-secondary-bg-color, white); padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: var(--tg-theme-button-color, #008c4f); margin-bottom: 30px; font-size: 26px; font-weight: bold; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #006c3b; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; background-color: #fafafa; }
        button { width: 100%; padding: 14px; background-color: var(--tg-theme-button-color, #008c4f); color: var(--tg-theme-button-text-color, white); border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: background-color 0.2s; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        .error { color: #d9534f; font-size: 14px; margin-top: 5px; min-height: 20px; }
        .otp-section, .success-message { display: none; }
        .success-message { text-align: center; padding: 20px; }
        .success-message h2 { color: #27ae60; }
        .optional-field { color: #666; font-size: 0.9em; }
        .timer-container { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; font-size: 14px; }
        .resend-otp { color: var(--tg-theme-link-color, #008c4f); cursor: pointer; }
        .resend-otp.disabled { color: #999; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container" id="formContainer">
        <h1>فرم ثبت نام</h1>
        
        <form id="registerForm">
            <div class="form-group">
                <label for="fullName">نام و نام خانوادگی:</label>
                <input type="text" id="fullName" required>
                <div class="error" id="fullNameError"></div>
            </div>
            
            <div class="form-group">
                <label for="nationalCode">کد ملی:</label>
                <input type="tel" id="nationalCode" required pattern="[0-9]{10}" inputmode="numeric">
                <div class="error" id="nationalCodeError"></div>
            </div>
            
            <div class="form-group">
                <label for="phoneNumber">شماره موبایل:</label>
                <input type="tel" id="phoneNumber" required pattern="09[0-9]{9}" inputmode="numeric">
                <div class="error" id="phoneError"></div>
            </div>
            
            <div class="form-group">
                <label for="inviteCode">کد معرف: <span class="optional-field">(اختیاری)</span></label>
                <input type="text" id="inviteCode">
            </div>
            
            <button type="submit" id="submitBtn">ثبت نام و دریافت کد</button>
        </form>
    </div>

    <div class="container otp-section" id="otpSection">
        <h1>تأیید شماره موبایل</h1>
        <p>کد ۶ رقمی به شماره شما ارسال شد. لطفاً آن را وارد کنید.</p>
        <div class="form-group">
            <label for="otpCode">کد تأیید:</label>
            <input type="tel" id="otpCode" required maxlength="6" inputmode="numeric">
            <div class="error" id="otpError"></div>
        </div>
        <button type="button" id="verifyBtn">تأیید و تکمیل ثبت نام</button>
        <div class="timer-container">
            <div class="resend-otp disabled" id="resendOtp">ارسال مجدد کد</div>
            <div class="timer" id="timer">02:00</div>
        </div>
    </div>
    
    <div class="container success-message" id="successMessage">
        <h2>✅ ثبت نام موفق</h2>
        <p>ثبت نام شما با موفقیت انجام شد. به زودی به ربات بازگردانده خواهید شد.</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tg = window.Telegram?.WebApp;
            
            const elements = {
                formContainer: document.getElementById('formContainer'),
                registerForm: document.getElementById('registerForm'),
                fullName: document.getElementById('fullName'),
                nationalCode: document.getElementById('nationalCode'),
                phoneNumber: document.getElementById('phoneNumber'),
                inviteCode: document.getElementById('inviteCode'),
                submitBtn: document.getElementById('submitBtn'),
                otpSection: document.getElementById('otpSection'),
                otpCode: document.getElementById('otpCode'),
                verifyBtn: document.getElementById('verifyBtn'),
                timer: document.getElementById('timer'),
                resendOtp: document.getElementById('resendOtp'),
                successMessage: document.getElementById('successMessage'),
                errors: {
                    fullName: document.getElementById('fullNameError'),
                    nationalCode: document.getElementById('nationalCodeError'),
                    phone: document.getElementById('phoneError'),
                    otp: document.getElementById('otpError')
                }
            };
            
            let countdownInterval;

            if (tg) {
                tg.ready();
            }

            // خواندن کد معرف از URL
            const urlParams = new URLSearchParams(window.location.search);
            const inviteCode = urlParams.get('inv');
            if (inviteCode) {
                elements.inviteCode.value = inviteCode;
            }

            // اعتبارسنجی و ارسال درخواست OTP
            elements.registerForm.addEventListener('submit', function(e) {
                e.preventDefault();
                if (validateForm()) {
                    sendOtpRequest();
                }
            });

            elements.verifyBtn.addEventListener('click', verifyOtp);
            elements.resendOtp.addEventListener('click', function() {
                if (!this.classList.contains('disabled')) {
                    sendOtpRequest();
                }
            });

            function validateForm() {
                let isValid = true;
                // Clear previous errors
                Object.values(elements.errors).forEach(el => el.textContent = '');

                if (!elements.fullName.value.trim()) {
                    elements.errors.fullName.textContent = 'نام و نام خانوادگی الزامی است.';
                    isValid = false;
                }
                if (!/^[0-9]{10}$/.test(elements.nationalCode.value.trim())) {
                    elements.errors.nationalCode.textContent = 'کد ملی باید ۱۰ رقم باشد.';
                    isValid = false;
                }
                if (!/^09[0-9]{9}$/.test(elements.phoneNumber.value.trim())) {
                    elements.errors.phone.textContent = 'شماره موبایل معتبر نیست.';
                    isValid = false;
                }
                return isValid;
            }
            
            function setLoadingState(button, isLoading, text) {
                button.disabled = isLoading;
                button.textContent = text;
            }

            function sendOtpRequest() {
                setLoadingState(elements.submitBtn, true, 'در حال ارسال کد...');
                // فرض می‌کنیم وبهوک ارسال OTP شما این است. آدرس را در صورت نیاز تغییر دهید.
                fetch('https://myn8n.sahmeto.com/webhook/newuser-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phoneNumber: elements.phoneNumber.value.trim(),
                        nationalCode: elements.nationalCode.value.trim()
                    })
                })
                .then(res => {
                    if (!res.ok) throw new Error('این شماره یا کد ملی قبلاً ثبت شده است.');
                    return res.json();
                })
                .then(() => {
                    elements.formContainer.style.display = 'none';
                    elements.otpSection.style.display = 'block';
                    startCountdown();
                })
                .catch(err => alert(err.message))
                .finally(() => setLoadingState(elements.submitBtn, false, 'ثبت نام و دریافت کد'));
            }

            function verifyOtp() {
                const otp = elements.otpCode.value.trim();
                if (!/^[0-9]{4,6}$/.test(otp)) {
                    elements.errors.otp.textContent = 'کد تأیید معتبر نیست.';
                    return;
                }
                setLoadingState(elements.verifyBtn, true, 'در حال تأیید...');
                // فرض می‌کنیم وبهوک تأیید OTP شما این است.
                fetch('https://myn8n.sahmeto.com/webhook/verify-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phoneNumber: elements.phoneNumber.value.trim(),
                        otpCode: otp
                    })
                })
                .then(res => {
                    if (!res.ok) throw new Error('کد وارد شده صحیح نیست.');
                    return res.json();
                })
                .then(() => completeRegistration())
                .catch(err => {
                    elements.errors.otp.textContent = err.message;
                    setLoadingState(elements.verifyBtn, false, 'تأیید و تکمیل ثبت نام');
                });
            }

            function completeRegistration() {
                setLoadingState(elements.verifyBtn, true, 'در حال ثبت نهایی...');
                // وبهوک نهایی برای ثبت اطلاعات کاربر
                fetch('https://myn8n.sahmeto.com/webhook/new-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fullName: elements.fullName.value.trim(),
                        nationalCode: elements.nationalCode.value.trim(),
                        phoneNumber: elements.phoneNumber.value.trim(),
                        inviteCode: elements.inviteCode.value.trim(),
                        telegramUser: tg?.initDataUnsafe?.user || null
                    })
                })
                .then(res => {
                    if (!res.ok) throw new Error('خطا در ثبت نهایی اطلاعات.');
                    return res.json();
                })
                .then(() => {
                    elements.otpSection.style.display = 'none';
                    elements.successMessage.style.display = 'block';
                    // بعد از ۳ ثانیه، وب‌اپ را به صورت خودکار می‌بندیم
                    setTimeout(() => {
                        tg?.close();
                    }, 3000);
                })
                .catch(err => {
                    alert(err.message);
                    setLoadingState(elements.verifyBtn, false, 'تأیید و تکمیل ثبت نام');
                });
            }
            
            function startCountdown() {
                clearInterval(countdownInterval);
                let duration = 120;
                elements.resendOtp.classList.add('disabled');
                
                countdownInterval = setInterval(() => {
                    const minutes = String(Math.floor(duration / 60)).padStart(2, '0');
                    const seconds = String(duration % 60).padStart(2, '0');
                    elements.timer.textContent = `${minutes}:${seconds}`;

                    if (--duration < 0) {
                        clearInterval(countdownInterval);
                        elements.resendOtp.classList.remove('disabled');
                        elements.timer.textContent = '00:00';
                    }
                }, 1000);
            }
        });
    </script>
</body>
</html>
